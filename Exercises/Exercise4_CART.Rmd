---
title: "Exercise 4"
author: "Nilima Ajaikumar, Hagay Jalon & Gian Zlupko"
date: "2022-11-14"
output: html_document
---

```{r message = FALSE, warning = FALSE}
library(tidyverse) 
library(xlsx) 
library(pROC) 
library(OptimalCutpoints) # for dealing with cutoff point
library(naniar) # replaces missing data to NA
```


# Part I: NECS Data 

For the first part of our Exercise 4, we are recreating the figures and tables published in Bowers & Zhou (2019). Our code and results for this section are organized as follows. First, we load and clean the NCES data. Then, we provide the code, documentation, and interpretation for Tables 1-3 and Figures 1-3 from Bowers & Zhou (2019) in the order in which they appear in the article. 

#### Import Data 

The following steps were implemented to access data from NCES' online repository. 


```{r}
setwd("/Users/gianzlupko/Desktop/ORLA 6541 Data Science/ORLA_6541_Applied_Data_Science/NCES_Data") 

# Load R Data File
load("els_full_data.rdata")

# simplify name of data frame 
els_full_data <- els_02_12_byf3pststu_v1_0


# variables that we would like to keep 

keepvars <- c(
   "STU_ID",
   "F2EVERDO", # Dropout
   "BYP52E", # Absent*
   "BYS24F", # Suspension*
   "BYP51", # Misbehavior*
   "BYTXMSTD", # Math t score (2002) - lowercase in the data
   "BYS42", # Extracurricular activities (2002) hours/wk
   "BYTXRSTD", # Reading t score (2002)* - lowercase in the data
   "F2PS0601", # College enrollment
   "F1RGPP2", # GPA
   "F1S27", # Extracurricular activities (2004) hours/wk
   "BYS33A", # AP
   "F3TZSTEM1CRED", # Postsecondary STEM degree
   "F3TZSTEM1TOT", # Number of STEM Courses
   "F3TZSTEM2GPA", # STEM course GPA
   "F3STEMOCCCUR" # Hard STEM career
)

# select subset of variables that were used in Bowers & Zhou (2019)
# also apply renaming to make the data readable 
els_clean <- els_full_data %>% 
  select(STU_ID, F2EVERDO, BYP52E, BYS24F, BYP51, bytxmstd, BYS42, bytxrstd,
         F2PS0601, F1RGPP2, F1S27, BYS33A, F3TZSTEM1CRED, F3TZSTEM1TOT,
         F3TZSTEM2GPA, F3STEMOCCCUR) %>%
  rename(student_ID = STU_ID, drop_out = F2EVERDO, absent = BYP52E, suspension = BYS24F, 
         misbehavior = BYP51, math_tscore = bytxmstd, extra_curr_2002 = BYS42, 
         reading_tscore = bytxrstd, college_enroll = F2PS0601, GPA = F1RGPP2, extra_curr_2004 = F1S27, AP = BYS33A, post_sec_stem = F3TZSTEM1CRED, no_stem_courses = F3TZSTEM1TOT, stem_GPA = F3TZSTEM2GPA, hard_stem_career = F3STEMOCCCUR)   

# inspect cleaning 
els_clean


# finally, create the feature engineered flags that Bowers & Zhou also tested to look at 
# the impact of the potential implication of one or more 'flags' or common indicators of 
# student drop out 
# the flags include: absent, suspension math_tscore in the 1st percentile, and misbehavior 

els_vars <- els_clean %>%
  mutate(flag_00 = ifelse(rowSums(select(., c(3:6)), na.rm = T) >= 1, 1, 0), 
         flag_01 = ifelse(absent == 1 | suspension == 1 | math_tscore == 1 | misbehavior == 1, 1,0), flag_04 = ifelse(absent == 1 & suspension == 1 & math_tscore == 1 & misbehavior == 1, 1, 0))

```

Remove missing data in the data set that are stored as -9, -8, -4, -1

```{r}
library(naniar)
els_complete <- replace_with_na_if(els_vars,
                                   .predicate = is.numeric,
                                   condition = ~.x < 0)

# Create the math t-score variable following Bowers' CART markdown 

els_complete <- els_complete %>% 
  mutate(math_t_score = ifelse(math_tscore < 44.065, 1, 0), 
         reading_t_score = ifelse(reading_tscore < 43.64, 1, 0))


# finally, view summary of clean variables 
summary(els_complete) 
```


Now that we have loaded and cleaned the data, we are ready to generate our first table and figure. Following Bowers & Zhou (2019), the first analysis that we run is to calculate and visualize an ROC AUC comparison of different predictors in the data on the drop out.  

#### Figure 1 and Table 1

Figure A depicts a ROC plot for some of the key following predictors of drop out that were presented in Bowers & Zhou (2019): any one flag, any two flags, absence, misbehavior, math t-score and reading t-score. 

Figure B demonstrates ROC curves for continuous predictors. 


```{r, message = FALSE}

# ROC for math t-score
roc1 = roc(els_complete$drop_out, els_complete$math_t_score, legacy.axes=TRUE, asp=FALSE, plot=TRUE, grid=FALSE, lty=1, xaxs="i", yaxs="i", main = "ROC curves for predicting dropout: Comparison")

# ROC for reading t-score 

roc2 = roc(els_complete$drop_out, els_complete$reading_t_score,
           plot=TRUE, add=TRUE, percent=roc1$percent, lty=2)

# ROC for one flag 

roc3 = roc(els_complete$drop_out, els_complete$flag_00, plot=TRUE, add=TRUE, percent=roc1$percent, lty=3)

legend("bottomright", legend=c("Math t score (2002)","Reading t score (2002)"), lty=c(1,2), lwd=2)

```



#### Table 1: Confusion Table for Calculating Contingency Proportions 


```{r}

fig_1_stats <- c("Accuracy", "Precision", "Sensitivity (Recall / True-positive Proportion",
                  "Specificity (True-negative Proportion", "1-Specificity (False-positive Proportion", "Kapp")

fig_1_equations <- c("(a + d) / N", 
                     "a / (a + b)", 
                     "a / (a + c)", 
                     "d / (b + d)", 
                     "b / (b + d)", 
                     "(Accuracy - R) / (1 - R)")

# bind columns 
fig_1 <- data.frame(cbind(fig_1_stats, fig_1_equations)) 
colnames(fig_1) <- c("Statistic", "Equation")
fig_1

```







